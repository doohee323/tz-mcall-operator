# Jenkins 복원 작업 기록

## 목표
Velero에서 가장 오래된 백업으로 Jenkins만 복원하되, 플러그인은 없어도 되지만 프로젝트 폴더는 유지한 상태로 UI만 띄우기

## 작업 내역

### 1단계: 초기 상황 파악
- Jenkins 2.462.3 실행 중
- 플러그인 없음 (Pipeline, Git, Kubernetes 등 필수 플러그인 미설치)
- 보안 취약점 경고 3개 존재

### 2단계: 플러그인 설치 시도
**문제 발생**: 플러그인 설치 실패
```
java.nio.file.AccessDeniedException: /var/jenkins_home/plugins/structs.jpi.tmp
```

**원인**: 
- Velero 복원 시 `/var/jenkins_home/plugins` 디렉토리가 `root:root` 소유
- Jenkins는 `jenkins:jenkins` (uid=1000)로 실행되어 쓰기 권한 없음
- fsGroup은 새 파일에만 적용되고 기존 파일 권한은 변경하지 않음

### 3단계: 권한 수정 시도
**시도 1**: 임시 Pod로 권한 수정
```bash
kubectl run fix-permissions --rm -i --overrides='...'
chown -R 1000:1000 /var/jenkins_home/plugins
```
✅ 성공했으나 재시작 시 다시 문제 발생

**시도 2**: StatefulSet에 InitContainer 추가
```bash
kubectl patch statefulset jenkins -n jenkins --type=json -p='[...]'
```
❌ `Init:CreateContainerConfigError` 발생

### 4단계: 처음부터 다시 시작
**결정**: Velero 가장 오래된 백업으로 완전히 새로 복원

1. 현재 Jenkins namespace 삭제
```bash
kubectl delete namespace jenkins
```

2. Velero 백업 목록 확인
- 가장 오래된 백업: `jenkins-pre-upgrade-20251011-201802`

3. 복원 실행
```bash
kubectl create -f - <<EOF
apiVersion: velero.io/v1
kind: Restore
metadata:
  name: restore-jenkins-oldest-20251012-141212
  namespace: velero
spec:
  backupName: jenkins-pre-upgrade-20251011-201802
  includedNamespaces:
  - jenkins
  restorePVs: true
EOF
```
✅ 복원 완료: 44개 아이템 복원, 7개 경고

### 5단계: PVC 문제 해결
**문제**: Pod가 Pending 상태
```
0/3 nodes are available: pod has unbound immediate PersistentVolumeClaims
```

**원인**: 
- Velero가 복원한 PVC가 존재하지 않는 PV를 참조
- PV `pvc-232cfef6-a8c0-4d01-9c05-a4cfebe49938` 없음

**해결**:
1. 문제있는 PVC 삭제
```bash
kubectl delete pvc jenkins -n jenkins
```

2. 새 PVC 수동 생성
```bash
kubectl apply -f - <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jenkins
  namespace: jenkins
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: nfs-client
  resources:
    requests:
      storage: 8Gi
EOF
```
✅ PVC Bound 성공

### 6단계: Jenkins UI 복원 완료
- Jenkins Pod 정상 시작: `1/2 Running` → `2/2 Running`
- UI 접근 가능: https://jenkins.drillquiz.com/
- Jenkins 2.462.3 정상 작동
- Build Executor: 2개 Idle

## ⚠️ 현재 문제

### jobs 폴더가 비어있음
```bash
jenkins@jenkins-0:~/jobs$ ls -al
total 8
drwxr-xr-x  2 jenkins jenkins 4096 Oct 12 21:15 .
drwxrwxrwx 12 root    root    4096 Oct 12 21:18 ..
```

### 원인
새로운 PVC를 생성했기 때문에 이전 프로젝트 데이터가 없음

### 발견한 것
```bash
kubectl get pv | grep jenkins
jenkins-clean-pv                           8Gi  RWO  Retain  Released  jenkins/jenkins  nfs-client
pvc-eaee4131-828a-4e4d-a634-34d40293b581   8Gi  RWO  Delete  Bound     jenkins/jenkins  nfs-client
```
- `jenkins-clean-pv` (Released 상태)에 이전 데이터가 있을 가능성
- 현재 사용 중인 PVC는 새로 만든 것 (비어있음)

## ✅ 해결됨: NFS 데이터 복원 완료

### jenkins-clean-pv 복원 성공
- NFS 경로: `/srv/nfs/archived-jenkins-jenkins-pvc-232cfef6-a8c0-4d01-9c05-a4cfebe49938`
- 10개 프로젝트 모두 복원됨 (tz-drillquiz-operator 포함)
- Jenkins UI 정상 작동

## ✅ 해결됨: Docker Build 문제

### 근본 원인
**타이밍 문제**: Jenkins가 docker daemon이 완전히 준비되기 전(약 17초 소요)에 명령을 실행

### 해결 방법
docker 컨테이너에 **readinessProbe** 추가:
```yaml
readinessProbe:
  exec:
    command: ["docker", "info"]
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
```

### 테스트 결과
- docker-test 프로젝트 빌드 #2: ✅ SUCCESS
- docker version: ✅ 성공
- docker info: ✅ 성공
- docker build (Alpine 이미지): ✅ 성공

### 최종 Pod Template 설정
```yaml
spec:
  containers:
  - name: kubectl
    image: doohee323/jenkins-slave
    command: [sleep]
    args: ["9999999"]
    securityContext:
      privileged: true
  - name: jnlp
    image: jenkins/inbound-agent:alpine
  - name: docker
    image: docker:24.0.2-dind
    env:
    - name: DOCKER_TLS_CERTDIR
      value: ""
    securityContext:
      privileged: true
    resources:
      requests:
        memory: 500Mi
      limits:
        memory: 2000Mi
    readinessProbe:  # ⭐ 핵심 추가 사항
      exec:
        command: ["docker", "info"]
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
```

## ✅ 완료: Velero 백업 설정 성공!

### 목표
Kopia를 사용하여 Jenkins PV 데이터를 제대로 백업

### 해결 과정

#### 1. Helm rollback 실행
- Revision 2 (v1.17.0) upgrade 실패 → Revision 1 (v1.16.1)로 rollback
- upgrade-crds Job 삭제 필요 (ServiceAccount 없음)
- Helm 릴리즈 정보 정리

#### 2. node-agent DaemonSet 수동 배포
Helm 대신 수동으로 DaemonSet 배포:
- **핵심 발견**: Velero가 찾는 label selector가 특정해야 함
  - selector: `name: node-agent` (필수!)
  - Pod labels: `name: node-agent`, `role: node-agent`
- ServiceAccount: `velero-server`
- Secret: `credentials-velero`
- SecurityContext:
  - `privileged: true`
  - `runAsUser: 0`
  - `capabilities: [SYS_ADMIN]`
- 리소스 요청:
  - CPU: 100m (500m은 너무 많음)
  - Memory: 256Mi

#### 3. 최종 백업 성공!
**백업명**: `jenkins-complete-20251012-172218`
- **Status**: ✅ **Completed**
- **PodVolumeBackup**: 6개 모두 Completed
  - ✅ `jenkins-home` (가장 중요!)
  - ✅ `jenkins-cache`
  - ✅ `jenkins`
  - ✅ `plugin-dir`
  - ✅ `sc-config-volume`
  - ✅ `tmp-volume`
- **Uploader**: Kopia
- **Duration**: ~2분 30초

### 핵심 교훈
1. Velero v1.16.1은 Kopia 사용 (Restic 아님)
2. node-agent DaemonSet의 selector와 label이 정확해야 함:
   ```yaml
   selector:
     matchLabels:
       name: node-agent  # 필수!
   template:
     metadata:
       labels:
         name: node-agent
         role: node-agent
   ```
3. Helm chart 템플릿 확인이 가장 정확함:
   ```
   helm template velero vmware-tanzu/velero --version 10.0.12 --set deployNodeAgent=true --show-only templates/node-agent-daemonset.yaml
   ```

### 생성된 파일
- `/tmp/node-agent-daemonset.yaml`: 수동 배포용 DaemonSet 정의

## 참고 파일
- 원본 Helm values: `/Volumes/workspace/tz/tz-k8s-vagrant/tz-local/resource/jenkins/helm/values.yaml`
- 플러그인 목록: `/Volumes/workspace/tz/tz-k8s-vagrant/tz-local/resource/jenkins/helm/plugin.txt`
- 설치 스크립트: `/Volumes/workspace/tz/tz-k8s-vagrant/tz-local/resource/jenkins/helm/install.sh`
- Velero values (수정): `/tmp/velero-values.yaml`



